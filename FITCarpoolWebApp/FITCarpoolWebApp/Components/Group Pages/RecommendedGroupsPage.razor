@using DataAccessLibrary.Data.Database;
@using DataAccessLibrary.Model;
@using DataAccessLibrary.Model.Database_Models;
@using DataAccessLibrary.Model.Logic_Models;
@using FITCarpoolWebApp.Components.Group_Pages.CreateGroupComponents;
@using Microsoft.AspNetCore.Authorization;
@using MudBlazor;
@inject Radzen.DialogService DialogService;
@inject HttpClient httpClient;
@inject IUsersData _dbUsers;
@inject ICarpoolGroupsData _dbGroups;
@inject AuthenticationStateProvider AuthenticationStateProvider;
@inject NotificationService NotificationService;
@inject NavigationManager NavigationManager;

@attribute [Authorize]
@page "/FindGroups";

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudGrid GutterSize="2">
        <!-- Left Panel: My Groups -->
        <MudItem xs="12" sm="4" md="3">
            <MudPaper Elevation="1" Class="pa-4">
                <MudText Typo="Typo.h6">My Groups</MudText>
                @if (CurrentUser != null && CurrentUser.UserType == "driver")
                {
                    <MudButton OnClick="OpenGroupDialog" Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Class="mb-2">Create Group</MudButton>
                }
                @if (MyGroups != null && MyGroups.Any())
                {
                    <MudList>
                        @foreach (var group in MyGroups)
                        {
                            <MudListItem>
                                <MudListItemContent>
                                    <MudText>@group.Item2</MudText>
                                </MudListItemContent>
                                <MudListItemIcon>
                                    <MudIconButton OnClick="@(async () => await ShowGroupDetails(group.Item1))" Color="Color.Error" Icon="@Icons.Material.Filled.Search" />

                                    <MudIconButton OnClick="@(async () => await LeaveGroup(group))" Color="Color.Error" Icon="@Icons.Material.Filled.ExitToApp" />
                                </MudListItemIcon>
                            </MudListItem>
                        }
                    </MudList>
                }
                else
                {
                    <MudText>No groups found.</MudText>
                }
            </MudPaper>
        </MudItem>

        <!-- Right Panel: Group Recommendations -->
        <MudItem xs="12" sm="8" md="9">
            <MudPaper Elevation="1" Class="pa-4">
                <MudText Typo="Typo.h5" Class="mb-2">Group Recommendations</MudText>
                <MudGrid>
                    <MudItem xs="12" sm="6" md="4" class="mb-2">
                        <MudSelect @bind-Value="SelectedSortOption" Label="Sort by" Dense="true" Margin="Margin.Dense" Variant="MudBlazor.Variant.Outlined" OnValueChanged="OnSortOptionChanged">
                            <MudSelectItem Value="@("DistanceScore")">Distance Score</MudSelectItem>
                            <MudSelectItem Value="@("PreferenceScore")">Preference Score</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4" class="mb-2">
                        <MudSwitch @bind-Checked="viewAutoGenerated" Color="Color.Primary" LabelPosition="LabelPosition.Start">
                            <LabelContent>
                                <MudText>Show Auto-Generated Groups</MudText>
                            </LabelContent>
                        </MudSwitch>
                    </MudItem>
                </MudGrid>

                @if (viewAutoGenerated)
                {
                    <!-- View auto-generated groups -->
                    @if (GeneratedGroupList != null && GeneratedGroupList.Any())
                    {
                        <MudGrid>
                            @foreach (var group in GeneratedGroupList)
                            {
                                <MudItem xs="12" sm="6" md="4">
                                    <MudCard Class="mb-4" Style="cursor:pointer;" @onclick="() => ShowGroupDetails(group)">
                                        <MudCardHeader>
                                            <MudText Typo="Typo.h6">@group.GroupName</MudText>
                                        </MudCardHeader>
                                        <MudCardContent>
                                            <MudText>Distance Score: @group.DistanceScore:F2</MudText>
                                            <MudText>Preference Score: @group.PreferenceScore:F2</MudText>
                                        </MudCardContent>
                                        <MudCardActions>
                                            <MudButton Color="Color.Primary" OnClick="@(async () => await CreateGroupFromRecommendation(group))">Create Group</MudButton>
                                        </MudCardActions>
                                    </MudCard>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                    else
                    {
                        <MudText>No auto-generated groups available.</MudText>
                    }
                }
                else
                {
                    <!-- View existing group recommendations -->
                    @if (RecommendedGroupsList != null && RecommendedGroupsList.Any())
                    {
                        <MudGrid>
                            @foreach (var group in RecommendedGroupsList)
                            {
                                <MudItem xs="12" sm="6" md="4">
                                    <MudCard Class="mb-4" Style="cursor:pointer;" @onclick="() => ShowGroupDetails(group)">
                                        <MudCardHeader>
                                            <MudText Typo="Typo.h6">@group.GroupName</MudText>
                                        </MudCardHeader>
                                        <MudCardContent>
                                            <MudText>Distance Score: @group.DistanceScore:F2</MudText>
                                            <MudText>Preference Score: @group.PreferenceScore:F2</MudText>
                                        </MudCardContent>
                                        <MudCardActions>
                                            <MudButton Color="Color.Primary" OnClick="@(async () => await AddGroup(group))">Join Group</MudButton>
                                        </MudCardActions>
                                    </MudCard>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                    else
                    {
                        <MudText>No groups available to choose from.</MudText>
                    }
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    UsersModel CurrentUser = null;
    List<RecomendedGroup> RecommendedGroupsList = new();
    List<RecomendedGroup> GeneratedGroupList = new();

    List<(int, string, int, int)> MyGroups = new();
    bool viewAutoGenerated = false;
    string SelectedSortOption = "DistanceScore";
    List<string> DaysOfTheWeek = new() { "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday" };

    protected override async Task OnInitializedAsync()
    {
        // Get the current authenticated user
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userName = user.Identity.IsAuthenticated ? user.Identity.Name : "Not found";

        // Fetch user details from the database
        var UserList = await _dbUsers.GetUser(userName);
        if (UserList.Any())
        {
            CurrentUser = UserList.First();
        }

        // Get the user's current groups
        MyGroups = await _dbGroups.GetCurrentGroups(CurrentUser.UserId);

        // Get existing group recommendations
        RecommendedGroupsList = await _dbGroups.GetAvailableGroups(CurrentUser.UserId, DaysOfTheWeek);

        // Get auto-generated groups using the recommendation algorithm
        GeneratedGroupList = await _dbGroups.GetRecommendGroups(CurrentUser.UserId, DaysOfTheWeek, "arrival");

        // Sort the recommended groups
        SortRecommendedGroups();
    }

    private void SortRecommendedGroups()
    {
        if (SelectedSortOption == "DistanceScore")
        {
            RecommendedGroupsList = RecommendedGroupsList.OrderBy(g => g.DistanceScore).ToList();
            GeneratedGroupList = GeneratedGroupList.OrderBy(g => g.DistanceScore).ToList();
        }
        else if (SelectedSortOption == "PreferenceScore")
        {
            RecommendedGroupsList = RecommendedGroupsList.OrderByDescending(g => g.PreferenceScore).ToList();
            GeneratedGroupList = GeneratedGroupList.OrderByDescending(g => g.PreferenceScore).ToList();
        }
    }

    private void OnSortOptionChanged(string value)
    {
        SelectedSortOption = value;
        SortRecommendedGroups();
    }

    private async Task AddGroup(RecomendedGroup group)
    {
        await _dbGroups.JoinGroup(CurrentUser.UserId, group.GroupID);
        NotificationService.Notify(NotificationSeverity.Success, "Group Added", $"You have been added to group {group.GroupName}");
        MyGroups = await _dbGroups.GetCurrentGroups(CurrentUser.UserId);
    }

    private async Task LeaveGroup((int, string, int, int) group)
    {
        if (group.Item4 == group.Item3)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Failed Operation", $"You can't leave group {group.Item2}");
            return;
        }
        MyGroups.Remove(group);
        await _dbGroups.RemoveGroupMember(CurrentUser.UserId, group.Item1);
        NotificationService.Notify(NotificationSeverity.Success, "Group Left", $"You have left group {group.Item2}");
    }

    private async Task ShowGroupDetails(RecomendedGroup group)
    {
        var parameters = new Dictionary<string, object> { { "CurrentGroup", group } };
        var options = new Radzen.DialogOptions
            {
                Width = "100%",   // Sets the dialog width to 100% of the screen
            };

        await DialogService.OpenAsync<ViewGroupDialog>("View Group", parameters, options);
    }

    private async Task ShowGroupDetails(int groupID)
    {
        await ShowGroupDetails(await _dbGroups.GetSingleGroup(groupID));
    }
    private async Task OpenGroupDialog()
    {
        await DialogService.OpenAsync<CreateGroupDialog>("Create Group", new Dictionary<string, object> { { "CurrentUser", CurrentUser } });
    }


    private async Task CreateGroupFromRecommendation(RecomendedGroup group)
    {
        // TODO: Implement the logic to create a new group from the auto-generated recommendation
        // This might involve calling methods from your _dbGroups service
        // For example:
        // int newGroupId = await _dbGroups.CreateGroup(group.GroupName, CurrentUser.UserId);
        // await _dbGroups.AddUsersToGroup(newGroupId, group.GroupMembers.Select(u => u.UserID).ToList());

        // Notify the user and refresh the groups list
        NotificationService.Notify(NotificationSeverity.Success, "Group Created", $"Group {group.GroupName} has been created.");
        MyGroups = await _dbGroups.GetCurrentGroups(CurrentUser.UserId);

    }
}
