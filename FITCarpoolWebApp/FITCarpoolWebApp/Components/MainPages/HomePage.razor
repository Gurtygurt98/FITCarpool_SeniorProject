@page "/"
@using FITCarpoolWebApp.Components.Account.Shared
@using MudBlazor
@using Radzen.Blazor
@inject NotificationService NotificationService
@using Microsoft.AspNetCore.Authorization
@using DataAccessLibrary.Model.Database_Models
@using Microsoft.EntityFrameworkCore
@using DataAccessLibrary.Data.Database
@using DataAccessLibrary.Model
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IUsersData _dbUsers
@inject IFriendsData _dbFriends
@inject IGroupScheduleData _dbGroupSchedule
@inject ICarpoolGroupsData _dbCarpoolGroups
@inject IRolesData _dbRoles

<AuthorizeView>
    @*User is logged in *@
    <Authorized>
        <MudText Typo="Typo.body1" Class="welcome-text">Welcome, @userModel.FirstName @userModel.LastName!</MudText>
        <RadzenCard Class="rz-my-12 rz-mx-auto" Style="width: 100%; overflow-x: auto;">
            <MudText Typo="Typo.h3" Align="Align.Start"><b>Today's Trip</b></MudText>
            <div style="display: flex; flex-direction: row; gap: 20px;">
                @if (upcomingTrips != null && upcomingTrips.Count > 0)
                {
                    var today = DateTime.Today;

                    var todayTrips = upcomingTrips.Where(trip => trip.Start.Date == today).ToList();

                    if (todayTrips.Count > 0)
                    {
                        @foreach (var trip in todayTrips)
                        {
                            <RadzenCard Class="rz-my-12" Style="min-width: 300px; width: auto;">
                                <MudText Typo="Typo.h4" Align="Align.Center">Day: @trip.Day</MudText>
                                <MudText Typo="Typo.h5" Align="Align.Center">Date: @trip.Start.ToString("MMMM dd, yyyy") at @trip.Start.ToString("hh:mm tt")</MudText>
                                <MudText Typo="Typo.h6" Align="Align.Center">
                                    Direction: @(trip.Direction == "arrival" ? "Arriving to Campus" : "Departing from Campus")
                                </MudText>
                                <MudText Typo="Typo.h6" Align="Align.Center">Role: @userRole</MudText>

                                    <RadzenButton Text="Confirm Ride" Click="@(() => NavigateToRiderConfirmation(@trip.GroupID))" Style="width: 100%; background-color: #D3D3D3; color: #333;" />

                            </RadzenCard>
                        }
                    }
                    else
                    {
                        <MudText Typo="Typo.h6">No rides today.</MudText>
                    }
                }
                else
                {
                    <MudText Typo="Typo.h6">No rides today.</MudText>
                }
            </div>


        </RadzenCard>


        @* Schedule Card on top *@
        <RadzenCard Class="rz-my-12 rz-mx-auto" Style="width: 100%; overflow-x: auto;">
            <RadzenRow>
                <RadzenColumn Width="70%">
                    <MudText Typo="Typo.h3" Align="Align.Start"><b>Future Trips</b></MudText>
                </RadzenColumn>
                <RadzenColumn Width="30%" Style="text-align: right;">
                    <RadzenButton Text="Find a Group!" Click="@(() => NavigateTo("FindGroups"))" ButtonStyle="ButtonStyle.Primary" />
                </RadzenColumn>
            </RadzenRow>

            <div style="display: flex; flex-direction: row; gap: 20px; overflow-x: auto; padding: 10px;">
                @if (upcomingTrips != null && upcomingTrips.Count > 0)
                {
                    var today = DateTime.Today;

                    // Filter and sort trips by start date
                    var allTrips = upcomingTrips
                    .Where(trip => trip.Start.Date != today)
                    .OrderBy(trip => trip.Start)
                    .ToList();

                    if (allTrips.Count > 0)
                    {
                        @foreach (var trip in allTrips)
                        {
                            <RadzenCard Class="rz-my-12" Style="min-width: 300px; width: auto;">
                                <MudText Typo="Typo.h4" Align="Align.Center">Day: @trip.Day</MudText>
                                <MudText Typo="Typo.h5" Align="Align.Center">Date: @trip.Start.ToString("MMMM dd, yyyy") at @trip.Start.ToString("hh:mm tt")</MudText>
                                <MudText Typo="Typo.h6" Align="Align.Center">
                                    Direction: @(trip.Direction == "arrival" ? "Arriving to Campus" : "Departing from Campus")
                                </MudText>
                                <MudText Typo="Typo.h6" Align="Align.Center">Role: @userRole</MudText>

                                <RadzenButton Text="Confirm Ride" Click="@(() => NavigateToRiderConfirmation(trip.GroupID))" Style="width: 100%; background-color: #D3D3D3; color: #333;" />
                                </RadzenCard>
                        }
                    }
                    else
                    {
                        <MudText Typo="Typo.h6">No upcoming rides found.</MudText>
                    }
                }
                else
                {
                    <MudText Typo="Typo.h6">No upcoming rides found.</MudText>
                }
            </div>
        </RadzenCard>



        @* Friends List Card on bottom *@
        <RadzenCard Class="rz-my-12 rz-mx-auto" Style="width: 100%; overflow-x: auto;">
            <MudText Typo="Typo.h3" Align="Align.Start"><b>Friends List</b></MudText>
            @if (friends != null && friends.Count > 0)
            {
                @foreach (var friend in friends)
                {
                    <RadzenCard Class="rz-my-12 rz-mx-auto" Style="width: 100%; overflow-x: auto;">

                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="Radzen.JustifyContent.Start" AlignItems="Radzen.AlignItems.Center" Gap="1rem" class="rz-p-4">
                            @if (!string.IsNullOrEmpty(friend.ProfilePicture))
                            {
                                //<RadzenImage Path="@($"data:image/jpeg;base64,{Convert.ToBase64String(friend.ProfilePicture)}")" Style="width: 100px; height: 100px; border-radius: 50%;" />
                            }
                            else
                            {
                                <RadzenImage Path="https://cdn.create.vista.com/api/media/medium/137014128/stock-vector-user-profile-icon?token" Style="width: 100px; height: 100px; border-radius: 50%;" />
                            }
                            <RadzenStack Gap="0">
                                <RadzenText TextStyle="TextStyle.H5">@friend.Name</RadzenText>
                            </RadzenStack>
                            <RadzenButton Text="View User" Click="@(() => ViewUser(friend.Email))" Style="margin-left:auto" />
                        </RadzenStack>
                    </RadzenCard>

                }
            }
            else
            {
                <MudText Typo="Typo.h6">No friends found.</MudText>
            }
        </RadzenCard>
    </Authorized>

    <NotAuthorized>
        <MudGrid>
            <MudItem xs="12" sm="6" md="6" lg="6">
                <RadzenStack Style="display: flex; align-items: center; justify-content: center; margin: 0 10px;">
                    <MudImage Src="https://scontent-mia3-1.xx.fbcdn.net/v/t39.30808-6/337879099_1147060015965896_3147312146304339976_n.jpg?stp=dst-jpg_tt6&_nc_cat=100&cb=99be929b-6bbdfb60&ccb=1-7&_nc_sid=cc71e4&_nc_ohc=hQzfuzI0_j8Q7kNvgGO-P4D&_nc_ht=scontent-mia3-1.xx&_nc_gid=AS7qWpThdZHOwZYAbs2FwSW&oh=00_AYDyTW7_8P3P5lMY4yvGez0Ah83Y4xjEjjANsTmFruUo8w&oe=670F557C"
                              Style="max-width: 100%; height: auto;"
                              Alt="Florida Tech"
                              Elevation="25"
                              Class="rounded-lg" />
                </RadzenStack>
            </MudItem>

            <MudItem xs="12" sm="6" md="6" lg="6">
                <RadzenCard Class="rz-my-12" Style="flex: 1; margin: 0 10px;">
                    <LoginForm />
                </RadzenCard>
            </MudItem>
        </MudGrid>
    </NotAuthorized>
</AuthorizeView>

@code {

    private string userName;
    private string userRole = "rider";
    private List<GroupScheduleModel> upcomingTrips = new();
    private List<Friend> friends = new();
    private int ID = 0;
    public UsersModel userModel = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name;

            // Fetch user details
            var userList = await _dbUsers.GetUser(userName);
            if (userList.Any())
            {
                userModel = userList.First();
                ID = userModel.UserId;

                // Fetch all groups for the user
                var userGroups = await _dbCarpoolGroups.GetCurrentGroups(ID);
                if (userGroups.Any())
                {
                    foreach (var group in userGroups)
                    {
                        int groupID = group.Item1;

                        // Use each retrieved group ID to get the schedule
                        var groupSchedules = await _dbGroupSchedule.GetScheduleForGroup(groupID);
                        if (groupSchedules != null)
                        {
                            upcomingTrips.AddRange(groupSchedules);
                        }

                    }
                }


                var friendList = await _dbFriends.GetFriends(ID);
                foreach (var dataFriend in friendList)
                {
                    List<UsersModel> temp;
                    if (dataFriend.UserId1 == ID)
                    {
                        temp = await _dbUsers.GetUser(dataFriend.UserId2);
                    }
                    else
                    {
                        temp = await _dbUsers.GetUser(dataFriend.UserId1);
                    }

                    if (dataFriend.Status.Equals("accepted") && temp.Any())
                    {
                        friends.Add(new Friend { Name = $"{temp.First().FirstName} {temp.First().LastName}" });
                    }
                }
            }
        }
    }

    private void NavigateToRiderConfirmation(int groupId)
    {
        // Construct the Rider-Confirmation page URL with the groupId as a query parameter
        var url = $"/Rider-Confirmation?groupId={Uri.EscapeDataString(groupId.ToString())}";
        NavigationManager.NavigateTo(url);
    }

    private void ViewUser(string email)
    {
        NavigationManager.NavigateTo($"/Other-User-Details/{email}");
    }
    private void NavigateTo(string page)
    {
        NavigationManager.NavigateTo($"/{page}");
    }

    public class Friend
    {
        public string Name { get; set; }
        public string ProfilePicture { get; set; }
        public string Email { get; set; } 
    }
}
<style>
    .welcome-text {
    font-size: 2.5rem; /* Default for larger screens */
}

    media (max-width: 768px) {
    .welcome-text {
        font-size: 1.5rem; /* Smaller font size for mobile */
        text-align: center; /* Center-align for smaller screens */
    }
}
</style>